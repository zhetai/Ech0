name: Release

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæ‰“ Tagï¼Œæ¯”å¦‚ v1.0.0

jobs:
  build:
    name: Build and Release
    runs-on: ubuntu-latest

    # ğŸ± æ„å»ºå¤šä¸ªå¹³å°çš„ç‰ˆæœ¬ï¼ˆè¿™é‡Œä»¥ Linux/amd64 å’Œ Linux/arm64 ä¸ºä¾‹ï¼‰
    strategy:
      matrix:
        goos: [linux]
        goarch: [amd64, arm64]

    steps:
      # âœ… æ‹‰å–æºç 
      - name: ğŸ”„ Checkout source code
        uses: actions/checkout@v4

      # âœ… é…ç½® GO ç¼“å­˜
      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      # âœ… è®¾ç½® Go ç¯å¢ƒ
      - name: ğŸ§° Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.3'

      # âœ… è®¾ç½® PNPM ç¼“å­˜
      - name: Cache pnpm store
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('web/pnpm-lock.yaml') }}

      # âœ… è®¾ç½® Node.js + PNPMï¼ˆå‰ç«¯æ„å»ºï¼‰
      - name: ğŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.15.0'
          cache: 'pnpm'

      - name: ğŸ“¦ Install PNPM
        run: npm install -g pnpm@latest-10

      # âœ… å®‰è£…å‰ç«¯ä¾èµ–å¹¶æ„å»º
      - name: ğŸ“¦ Install frontend deps
        working-directory: ./web  # âš ï¸ æ›¿æ¢æˆä½ å‰ç«¯ç›®å½•
        run: pnpm install

      - name: ğŸ”§ Build frontend
        working-directory: ./web
        run: pnpm build --mode production

      # âœ… æ„å»ºåç«¯äºŒè¿›åˆ¶
      - name: ğŸ› ï¸ Build Go backend (${{ matrix.goos }}/${{ matrix.goarch }})
        run: |
          mkdir -p dist
          GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} CGO_ENABLED=1 \
          go build -o dist/ech0-${{ matrix.goos }}-${{ matrix.goarch }} ./cmd/server/main.go

      # âœ… æ‰“åŒ…åç«¯äºŒè¿›åˆ¶
      - name: ğŸ“¦ Package backend binary
        run: |
          cd dist
          tar -czvf ech0-${{ matrix.goos }}-${{ matrix.goarch }}.tar.gz ech0-${{ matrix.goos }}-${{ matrix.goarch }}
          rm ech0-${{ matrix.goos }}-${{ matrix.goarch }}

      # âœ… æ‰“åŒ…å‰ç«¯æ„å»ºäº§ç‰©ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰
      - name: ğŸ“¦ Package frontend (only once)
        if: matrix.goarch == 'amd64' && matrix.goos == 'linux'
        run: |
          tar -czvf dist/template.tar.gz -C web/dist .

      # âœ… æ‰“åŒ…é…ç½®æ–‡ä»¶
      - name: ğŸ“¦ Package config file
        run: |
          tar -czvf dist/config.tar.gz -C config .
        
      # âœ… ä¸Šä¼  Release èµ„æº
      - name: ğŸš€ Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}