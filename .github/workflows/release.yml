name: Release

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæ‰“ Tagï¼Œæ¯”å¦‚ v1.0.0

permissions:
  contents: write
  packages: write

jobs:
  build:
    name: Build and Release
    runs-on: ubuntu-latest

    # ğŸ± æ„å»ºå¤šä¸ªå¹³å°çš„ç‰ˆæœ¬ï¼ˆè¿™é‡Œä»¥ Linux/amd64 å’Œ Linux/arm64 ä¸ºä¾‹ï¼‰
    strategy:
      matrix:
        goos: [linux]
        goarch: [amd64]
      max-parallel: 1

    steps:
      # âœ… æ‹‰å–æºç 
      - name: ğŸ”„ Checkout source code
        uses: actions/checkout@v4

      # âœ… æ¸…ç† Go ç¼“å­˜ç›®å½•
      - name: ğŸ§¹ Clean Go cache directory
        run: rm -rf ~/.cache/go-build ~/go/pkg/mod

      # é…ç½® Go ç¼“å­˜
      # - name: Cache Go modules
      #   uses: actions/cache@v4
      #   with:
      #     path: |
      #       ~/.cache/go-build
      #       ~/go/pkg/mod
      #     key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
      #     restore-keys: |
      #       ${{ runner.os }}-go-
      #     fail-on-cache-miss: false

      # âœ… è®¾ç½® Go ç¯å¢ƒ
      - name: ğŸ§° Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.3'
      
      # è®¾ç½® Go ä»£ç†
      - name: ğŸ§™ Set Go proxy
        run: go env -w GOPROXY=https://proxy.golang.org,direct

      - uses: pnpm/action-setup@v4
        name: ğŸ“¦ Install pnpm
        with:
          version: 10
          run_install: false

      - name: ğŸ“¦ Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache-dependency-path: 'web/pnpm-lock.yaml'
          cache: 'pnpm'

      # éªŒè¯ PNPM å®‰è£…
      - name: ğŸ‘¾ Verify PNPM installation
        run: pnpm --version

      # âœ… å®‰è£…å‰ç«¯ä¾èµ–å¹¶æ„å»º
      - name: ğŸ“¦ Install frontend deps
        working-directory: ./web 
        run: pnpm install

      - name: ğŸ”§ Build frontend
        working-directory: ./web
        run: pnpm build --mode production

      # âœ… æ„å»ºåç«¯äºŒè¿›åˆ¶
      - name: ğŸ› ï¸ Build Go backend (${{ matrix.goos }}/${{ matrix.goarch }})
        run: |
          mkdir -p dist
          GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} CGO_ENABLED=1 \
          go build -o dist/ech0-${{ matrix.goos }}-${{ matrix.goarch }} ./cmd/server/main.go

      # âœ… æ‰“åŒ…åç«¯äºŒè¿›åˆ¶
      - name: ğŸ“¦ Package backend binary
        run: |
          cd dist
          tar -czvf ech0-${{ matrix.goos }}-${{ matrix.goarch }}.tar.gz ech0-${{ matrix.goos }}-${{ matrix.goarch }}
          rm ech0-${{ matrix.goos }}-${{ matrix.goarch }}

      # âœ… æ‰“åŒ…å‰ç«¯æ„å»ºäº§ç‰©ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰
      - name: ğŸ“¦ Package frontend (only once)
        if: matrix.goarch == 'amd64' && matrix.goos == 'linux'
        run: |
          tar -czvf dist/ech0-template.tar.gz -C web/dist .

      # âœ… æ‰“åŒ…é…ç½®æ–‡ä»¶
      - name: ğŸ“¦ Package config file
        run: |
          tar -czvf dist/ech0-config.tar.gz -C config .

      # âœ… æ‰“åŒ…æœ€ç»ˆçš„å®Œæ•´å‹ç¼©åŒ…
      - name: ğŸ“¦ Package final release bundle
        run: |
          mkdir -p dist/ech0-release/config
          mkdir -p dist/ech0-release/template

          cp dist/ech0-${{ matrix.goos }}-${{ matrix.goarch }} dist/ech0-release/ech0

          cp -r config/* dist/ech0-release/config/

          cp -r web/dist/* dist/ech0-release/template/

          cd dist
          tar -czvf ech0-release-${{ matrix.goos }}-${{ matrix.goarch }}.tar.gz ech0-release
          rm -rf ech0-release
              
      # âœ… ä¸Šä¼  Release èµ„æº
      - name: ğŸš€ Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # âœ… ç™»å½• GHCR
      - name: ğŸ³ Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      # âœ… ç™»å½• Docker Hub
      - name: ğŸ³ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # âœ… æ„å»º Docker é•œåƒï¼ˆå¸¦ tag ç‰ˆæœ¬ï¼‰
      - name: ğŸ³ Build Docker image
        run: |
          GHCR_TAG=ghcr.io/${{ github.repository_owner }}/ech0:${{ github.ref_name }}
          GHCR_LATEST=ghcr.io/${{ github.repository_owner }}/ech0:latest
          DOCKER_TAG=docker.io/${{ vars.DOCKERHUB_USERNAME }}/ech0:${{ github.ref_name }}
          DOCKER_LATEST=docker.io/${{ vars.DOCKERHUB_USERNAME }}/ech0:latest

          docker build -t $GHCR_TAG -t $GHCR_LATEST -t $DOCKER_TAG -t $DOCKER_LATEST .


      # âœ… æ¨é€ Docker é•œåƒ
      - name: ğŸ“¤ Push Docker images
        run: |
          docker push ghcr.io/${{ github.repository_owner }}/ech0:${{ github.ref_name }}
          docker push ghcr.io/${{ github.repository_owner }}/ech0:latest
          docker push docker.io/${{ vars.DOCKERHUB_USERNAME }}/ech0:${{ github.ref_name }}
          docker push docker.io/${{ vars.DOCKERHUB_USERNAME }}/ech0:latest
